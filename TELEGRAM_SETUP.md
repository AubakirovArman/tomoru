# Настройка Telegram интеграции

## 1. Установка и настройка ngrok

### Установка ngrok
```bash
# Установка через Homebrew (macOS)
brew install ngrok/ngrok/ngrok

# Или скачайте с официального сайта: https://ngrok.com/download
```

### Регистрация и получение токена
1. Зарегистрируйтесь на https://ngrok.com/
2. Получите ваш authtoken в личном кабинете
3. Настройте ngrok:
```bash
ngrok config add-authtoken YOUR_AUTHTOKEN
```

## 2. Запуск приложения и ngrok

### Запуск Next.js приложения
```bash
npm run dev
# Приложение запустится на http://localhost:3000
```

### Запуск ngrok туннеля
В новом терминале:
```bash
ngrok http 3000
```

Вы получите URL вида: `https://abc123.ngrok.io`

## 3. Создание Telegram бота

### Пошаговая инструкция с BotFather:

1. **Найдите @BotFather** в Telegram и начните диалог
2. **Отправьте команду** `/newbot`
3. **Введите имя бота** (например: "My AI Assistant")
4. **Введите username бота** (должен заканчиваться на "bot", например: "myaiassistant_bot")
5. **ВАЖНО**: BotFather создаст бота и даст вам **ТОКЕН** (не промт!)
6. **Сохраните токен** - это строка вида: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`

### Что делать, если BotFather дал только промт:

- Это означает, что бот **НЕ БЫЛ СОЗДАН**
- Попробуйте другой username (возможно, выбранный уже занят)
- Убедитесь, что username заканчивается на "bot"
- Повторите процесс с командой `/newbot`

### Пример успешного создания:
```
BotFather: Congratulations! You've just created a new bot.
Token: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
Keep your token secure and store it safely...
```

## 4. Настройка интеграции в приложении

1. Откройте ваше приложение в браузере
2. Перейдите в раздел "Каналы"
3. Выберите бота для настройки
4. В разделе "Интеграция с Telegram":
   - Введите токен Telegram бота
   - Нажмите "Подключить Telegram"

## 5. Тестирование

1. Найдите вашего бота в Telegram по username
2. Отправьте команду `/start`
3. Задайте любой вопрос
4. Бот должен ответить согласно настройкам вашего AI ассистента

## Важные замечания

- **ngrok URL изменяется** при каждом перезапуске. Для продакшена используйте постоянный домен
- **Веб-хук автоматически настраивается** при подключении бота
- **Каждый бот может иметь** свою собственную Telegram интеграцию
- **Сообщения обрабатываются** через OpenAI Assistant API

## Структура веб-хука

Веб-хук доступен по адресу:
```
https://your-domain.com/api/telegram/webhook?token=TELEGRAM_BOT_TOKEN
```

## Troubleshooting

### Бот не отвечает
1. Проверьте, что ngrok запущен и доступен
2. Убедитесь, что токен введен правильно
3. Проверьте логи в консоли Next.js

### Ошибка "Invalid token"
1. Проверьте токен у @BotFather
2. Убедитесь, что токен скопирован полностью

### Веб-хук не работает
1. Проверьте доступность ngrok URL
2. Убедитесь, что приложение запущено на порту 3000
3. Проверьте настройки веб-хука в Telegram API